<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trip Details - Expense Wizard</title>
    <link rel="stylesheet" href="assets/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="app-title">
                    <img src="assets/logo.png" alt="expense.it" class="app-logo">
                    <span class="app-name">expense<span class="brand-it">.it</span></span>
                </div>
                <a href="index.html" class="back-link">
                    <i data-feather="arrow-left"></i> Back to Dashboard
                </a>
            </div>
            <h1 id="tripTitle">Trip Details</h1>
        </header>

        <div class="trip-details" id="tripContent">
            <div class="loading" id="loadingState">
                <div class="spinner"></div>
                <p>Loading trip details...</p>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Receipt</h3>
                <button class="modal-close" onclick="closeModal()">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="modalContent"></div>
            </div>
        </div>
    </div>



    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // Initialize feather icons
        feather.replace();

        let currentTrip = null;
        let receiptsData = [];

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const tripName = urlParams.get('trip');
            
            if (tripName) {
                loadTripDetails(tripName);
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadTripDetails(tripName) {
            try {
                const response = await fetch(`api.php?action=trip&name=${encodeURIComponent(tripName)}`);
                const data = await response.json();
                
                if (data.success) {
                    currentTrip = data.trip;
                    displayTripDetails(data.trip);
                    loadTravelDocuments(data.trip.name);
                    loadTripReceipts(data.trip.name);
                } else {
                    showError('Failed to load trip details');
                }
            } catch (error) {
                console.error('Error loading trip:', error);
                showError('Error loading trip details');
            }
        }

        function displayTripDetails(trip) {
            const tripTitle = document.getElementById('tripTitle');
            const tripContent = document.getElementById('tripContent');
            
            tripTitle.innerHTML = `<i data-feather="map"></i> ${trip.metadata.name}`;
            
            const allExpenses = trip.expenses || [];
            // Filter out travel documents from expenses
            const expenses = allExpenses.filter(expense => !expense.is_travel_document);
            const total = expenses.filter(expense => !expense.excluded).reduce((sum, expense) => sum + parseFloat(expense.amount || 0), 0);
            
            // Group expenses by category
            const categories = {};
            expenses.forEach(expense => {
                const category = expense.category || 'Uncategorized';
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push(expense);
            });

            tripContent.innerHTML = `
                <div class="trip-summary">
                    <div class="trip-stats">
                        <div class="stat-item">
                            <div class="stat-icon duration">
                                <i data-feather="calendar"></i>
                            </div>
                            <div class="stat-content">
                                <h3>Duration</h3>
                                <p>${formatDate(trip.metadata.start_date)} - ${formatDate(trip.metadata.end_date)}</p>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon expenses">
                                <i data-feather="file-text"></i>
                            </div>
                            <div class="stat-content">
                                <h3>Expenses</h3>
                                <p>${expenses.length} items</p>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon total">
                                <i data-feather="dollar-sign"></i>
                            </div>
                            <div class="stat-content">
                                <h3>Total</h3>
                                <p>$${total.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="trip-actions">
                        <button class="btn btn-primary" onclick="editTrip()">
                            <i data-feather="edit"></i> Edit Trip
                        </button>
                        <button class="btn btn-secondary" onclick="downloadReport()">
                            <i data-feather="download"></i> Download PDF
                        </button>
                        <button class="btn btn-outline" onclick="addExpense()">
                            <i data-feather="plus"></i> Add Expense
                        </button>
                        <button class="btn btn-danger" onclick="deleteTrip()">
                            <i data-feather="trash-2"></i> Delete Trip
                        </button>
                    </div>
                    
                    ${trip.metadata.notes ? `
                        <div class="trip-notes">
                            <h3><i data-feather="file-text"></i> Notes</h3>
                            <p>${trip.metadata.notes}</p>
                        </div>
                    ` : ''}
                </div>

                <div class="travel-documents-section">
                    <h2><i data-feather="file-text"></i> Travel Documents</h2>
                    <div class="documents-grid" id="documentsGrid">
                        <!-- Travel documents will be loaded here -->
                    </div>
                </div>

                <div class="receipts-section">
                    <div class="section-header">
                        <h2><i data-feather="paperclip"></i> Receipts</h2>
                        <button class="btn btn-secondary" onclick="bulkDownloadReceipts()" id="bulkDownloadBtn" style="display: none;">
                            <i data-feather="download"></i> Download All Receipts
                        </button>
                    </div>
                    <div class="receipts-grid" id="receiptsGrid">
                        <!-- Receipts will be loaded here -->
                    </div>
                </div>

                <div class="expenses-section">
                    <h2><i data-feather="list"></i> Expenses</h2>
                    
                    ${Object.keys(categories).length > 0 ? Object.keys(categories).map(category => `
                        <div class="category-section">
                            <h3 class="category-title">
                                <i data-feather="tag"></i> ${category}
                                <span class="category-total">$${categories[category].filter(exp => !exp.excluded).reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0).toFixed(2)}</span>
                            </h3>
                            <div class="expenses-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Merchant</th>
                                            <th>Amount</th>
                                            <th>Note</th>
                                            <th>Receipt</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${categories[category].map(expense => `
                                            <tr class="${expense.excluded ? 'excluded-expense' : ''}">
                                                <td>${formatDate(expense.date)}</td>
                                                <td>${expense.merchant || '-'}</td>
                                                <td class="amount">$${parseFloat(expense.amount || 0).toFixed(2)}</td>
                                                <td>${formatExpenseNote(expense.note)}</td>
                                                <td>
                                                    ${expense.source ? `
                                                        <a href="data/trips/${currentTrip.name}/${expense.source.replace(/\s+/g, '_').replace(/\u202f/g, '').replace('4.05.38', '40538').replace('4.05.57', '40557').replace('_AM', 'AM')}" target="_blank" class="btn btn-small">
                                                            <i data-feather="eye"></i> View
                                                        </a>
                                                    ` : '-'}
                                                </td>
                                                <td>
                                                    <button class="btn btn-small" onclick="editExpense('${expense.id}')">
                                                        <i data-feather="edit-2"></i>
                                                    </button>
                                                    <button class="btn btn-small ${expense.excluded ? 'btn-success' : 'btn-warning'}" onclick="toggleExpenseExclusion('${expense.id}')">
                                                        <i data-feather="${expense.excluded ? 'eye' : 'eye-off'}"></i>
                                                        ${expense.excluded ? 'Include' : 'Exclude'}
                                                    </button>
                                                    <button class="btn btn-small btn-danger" onclick="deleteExpense('${expense.id}')">
                                                        <i data-feather="trash-2"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `).join('') : `
                        <div class="empty-state">
                            <i data-feather="inbox"></i>
                            <h3>No expenses found</h3>
                            <p>This trip doesn't have any expenses yet.</p>
                            <button class="btn btn-primary" onclick="addExpense()">
                                <i data-feather="plus"></i> Add First Expense
                            </button>
                        </div>
                    `}
                </div>
            `;
            
            // Re-initialize feather icons
            feather.replace();
        }

        function editTrip() {
            window.location.href = `edit.html?trip=${encodeURIComponent(currentTrip.name)}`;
        }

        function addExpense() {
            window.location.href = `edit.html?trip=${encodeURIComponent(currentTrip.name)}&action=add`;
        }

        function editExpense(expenseId) {
            window.location.href = `edit.html?trip=${encodeURIComponent(currentTrip.name)}&expense=${expenseId}`;
        }

        async function deleteExpense(expenseId) {
            showConfirmModal('Delete Expense', 'Are you sure you want to delete this expense?', async () => {
                await executeDeleteExpense(expenseId);
            });
        }

        async function executeDeleteExpense(expenseId) {

            try {
                const response = await fetch('save_trip.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'delete_expense',
                        tripName: currentTrip.name,
                        expenseId: expenseId
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showSuccessMessage('Expense deleted successfully');
                    // Reload trip details
                    loadTripDetails(currentTrip.name);
                } else {
                    showErrorMessage('Error deleting expense');
                }
            } catch (error) {
                console.error('Error deleting expense:', error);
                showErrorMessage('Error deleting expense');
            }
        }

        async function downloadReport() {
            try {
                const response = await fetch(`generate_pdf.php?trip=${encodeURIComponent(currentTrip.name)}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${currentTrip.name}-report.pdf`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    showErrorMessage('Error generating PDF report');
                }
            } catch (error) {
                console.error('Error downloading report:', error);
                showErrorMessage('Error downloading report');
            }
        }

        async function deleteTrip() {
            const tripName = currentTrip.metadata.name;
            
            showConfirmModal('Delete Trip', `Delete "${tripName}"?\n\nThis will permanently delete all trip data including expenses and receipts. This action cannot be undone.`, async () => {
                await executeDeleteTrip(tripName);
            });
        }

        async function executeDeleteTrip(tripName) {

            try {
                const response = await fetch('save_trip.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'delete_trip',
                        tripName: currentTrip.name
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showSuccessMessage('Trip deleted successfully');
                    window.location.href = 'index.html';
                } else {
                    showErrorMessage('Error deleting trip: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting trip:', error);
                showErrorMessage('Error deleting trip');
            }
        }

        function showError(message) {
            const tripContent = document.getElementById('tripContent');
            tripContent.innerHTML = `
                <div class="error-state">
                    <i data-feather="alert-circle"></i>
                    <h3>Error</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="window.location.href='index.html'">
                        <i data-feather="home"></i> Back to Dashboard
                    </button>
                </div>
            `;
            feather.replace();
        }

        let receiptsData = [];
        let documentsData = [];

        async function loadTravelDocuments(tripName) {
            try {
                const response = await fetch(`api.php?action=travel_documents&name=${encodeURIComponent(tripName)}`);
                const data = await response.json();
                
                if (data.success && data.documents) {
                    documentsData = data.documents;
                    displayTravelDocuments(data.documents);
                }
            } catch (error) {
                console.error('Error loading travel documents:', error);
            }
        }

        function displayTravelDocuments(documents) {
            const documentsGrid = document.getElementById('documentsGrid');
            
            if (documents.length === 0) {
                documentsGrid.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="file-text"></i>
                        <h3>No travel documents found</h3>
                        <p>No travel document files are associated with this trip.</p>
                    </div>
                `;
            } else {
                documentsGrid.innerHTML = documents.map(document => `
                    <div class="document-item">
                        <div class="document-preview">
                            <div class="file-icon"><i data-feather="file-text"></i></div>
                        </div>
                        <div class="document-info">
                            <div class="document-name">${document.filename}</div>
                            <div class="document-size">${formatFileSize(document.size)}</div>
                            <div class="document-type">PDF Document</div>
                        </div>
                        <div class="document-actions">
                            <a href="${document.fullUrl}" target="_blank" class="btn btn-small">
                                <i data-feather="eye"></i> View
                            </a>
                        </div>
                    </div>
                `).join('');
            }
            
            feather.replace();
        }

        async function loadTripReceipts(tripName) {
            try {
                const response = await fetch(`api.php?action=receipts&name=${encodeURIComponent(tripName)}`);
                const data = await response.json();
                
                if (data.success && data.receipts) {
                    // Store receipts data globally for bulk download with proper URLs
                    receiptsData = data.receipts.map(receipt => ({
                        ...receipt,
                        fullUrl: receipt.url,
                        filename: receipt.filename || receipt.url.split('/').pop()
                    }));
                    displayReceipts(data.receipts);
                }
            } catch (error) {
                console.error('Error loading receipts:', error);
            }
        }

        function displayReceipts(receipts) {
            const receiptsGrid = document.getElementById('receiptsGrid');
            const bulkDownloadBtn = document.getElementById('bulkDownloadBtn');
            
            if (receipts.length === 0) {
                bulkDownloadBtn.style.display = 'none';
                receiptsGrid.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="paperclip"></i>
                        <h3>No receipts found</h3>
                        <p>No receipt files are associated with this trip.</p>
                    </div>
                `;
            } else {
                bulkDownloadBtn.style.display = 'inline-flex';
                receiptsGrid.innerHTML = receipts.map(receipt => `
                    <div class="receipt-item">
                        <div class="receipt-preview">
                            ${receipt.isPdf ? 
                                `<div class="file-icon"><i data-feather="file-text"></i></div>` :
                                `<img src="${receipt.fullUrl}" alt="${receipt.filename}" class="receipt-thumbnail" loading="lazy">`
                            }
                        </div>
                        <div class="receipt-info">
                            <div class="receipt-name">${receipt.filename}</div>
                            <div class="receipt-size">${formatFileSize(receipt.size)}</div>
                            ${receipt.isPdf ? '<div class="receipt-type">PDF Document</div>' : '<div class="receipt-type">Image</div>'}
                        </div>
                        <div class="receipt-actions">
                            <a href="${receipt.fullUrl}" target="_blank" class="btn btn-small">
                                <i data-feather="eye"></i> View
                            </a>
                            <a href="${receipt.fullUrl}" download class="btn btn-small btn-secondary">
                                <i data-feather="download"></i> Download
                            </a>
                        </div>
                    </div>
                `).join('');
            }
            
            feather.replace();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
        }



        // Custom modal functions
        let confirmAction = null;

        function showConfirmModal(title, message, action) {
            // Create modal if it doesn't exist
            if (!document.getElementById('confirmModal')) {
                const modal = document.createElement('div');
                modal.id = 'confirmModal';
                modal.className = 'modal';
                modal.style.display = 'none';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="confirmTitle">Confirm Action</h3>
                        </div>
                        <div class="modal-body">
                            <p id="confirmMessage">Are you sure?</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
                            <button class="btn btn-danger" id="confirmButton" onclick="executeConfirmAction()">Confirm</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            confirmAction = action;
            document.getElementById('confirmModal').style.display = 'flex';
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
            confirmAction = null;
        }

        function executeConfirmAction() {
            if (confirmAction) {
                confirmAction();
            }
            closeConfirmModal();
        }

        function showSuccessMessage(message) {
            createToast(message, 'success');
        }

        function showErrorMessage(message) {
            createToast(message, 'error');
        }

        function createToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i data-feather="${type === 'success' ? 'check-circle' : 'alert-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);
            feather.replace();
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        async function toggleExpenseExclusion(expenseId) {
            try {
                const response = await fetch('save_trip.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'toggle_expense_exclusion',
                        tripName: currentTrip.name,
                        expenseId: expenseId
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showSuccessMessage(result.excluded ? 'Expense excluded from totals' : 'Expense included in totals');
                    // Reload the trip to update the display
                    loadTrip(currentTrip.name);
                } else {
                    showErrorMessage('Failed to update expense: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error toggling expense exclusion:', error);
                showErrorMessage('Error updating expense exclusion');
            }
        }

        function editExpense(expenseId) {
            // Find the expense to edit
            const expense = currentTrip.expenses.find(exp => exp.id === expenseId);
            if (!expense) {
                showErrorMessage('Expense not found');
                return;
            }
            
            // Create edit modal (simplified for now)
            showSuccessMessage('Edit functionality will be implemented');
        }

        function deleteExpense(expenseId) {
            showConfirmModal(
                'Delete Expense',
                'Are you sure you want to permanently delete this expense? This action cannot be undone.',
                async () => {
                    try {
                        const response = await fetch('save_trip.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                action: 'delete_expense',
                                tripName: currentTrip.name,
                                expenseId: expenseId
                            })
                        });

                        const result = await response.json();
                        
                        if (result.success) {
                            showSuccessMessage('Expense deleted successfully');
                            loadTrip(currentTrip.name);
                        } else {
                            showErrorMessage('Failed to delete expense: ' + (result.error || 'Unknown error'));
                        }
                    } catch (error) {
                        console.error('Error deleting expense:', error);
                        showErrorMessage('Error deleting expense');
                    }
                }
            );
        }

        function addExpense() {
            showSuccessMessage('Add expense functionality will be implemented');
        }

        function editTrip() {
            showSuccessMessage('Edit trip functionality will be implemented');
        }

        function downloadReport() {
            window.open(`generate_pdf.php?trip=${encodeURIComponent(currentTrip.name)}`, '_blank');
        }

        function deleteTrip() {
            showConfirmModal(
                'Delete Trip',
                'Are you sure you want to permanently delete this trip and all its data? This action cannot be undone.',
                () => {
                    showSuccessMessage('Delete trip functionality will be implemented');
                }
            );
        }

        function formatExpenseNote(note) {
            if (!note || note === '-') return '-';
            
            // Split by newlines and common delimiters
            const items = note.split(/[\n\r]+|(?:\d+\.)|Items Purchased:/)
                .filter(item => item.trim().length > 0)
                .map(item => item.trim().replace(/^[\d\.\s]*/, ''));
            
            if (items.length <= 3) {
                return escapeHtml(note);
            }
            
            // Show first 3 items with tooltip for full content
            const previewItems = items.slice(0, 3);
            const preview = previewItems.join(', ') + '...';
            
            return `<span class="note-preview" title="${escapeHtml(note)}">${escapeHtml(preview)}</span>`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function bulkDownloadReceipts() {
            if (!currentTrip || !receiptsData || receiptsData.length === 0) {
                showErrorMessage('No receipts available for download');
                return;
            }

            try {
                showSuccessMessage('Preparing receipts for download...');
                
                // Create a zip file using JSZip
                if (typeof JSZip === 'undefined') {
                    // Fallback: download receipts one by one
                    for (const receipt of receiptsData) {
                        const link = document.createElement('a');
                        link.href = receipt.fullUrl;
                        link.download = receipt.filename;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        // Small delay between downloads
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    showSuccessMessage(`Downloaded ${receiptsData.length} receipts individually`);
                } else {
                    // Use JSZip for better bulk download
                    const zip = new JSZip();
                    
                    for (const receipt of receiptsData) {
                        try {
                            const response = await fetch(receipt.fullUrl);
                            const blob = await response.blob();
                            zip.file(receipt.filename, blob);
                        } catch (error) {
                            console.error(`Failed to add ${receipt.filename} to zip:`, error);
                        }
                    }
                    
                    const zipBlob = await zip.generateAsync({type: 'blob'});
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(zipBlob);
                    link.download = `${currentTrip.name}_receipts.zip`;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                    
                    showSuccessMessage(`Downloaded ${receiptsData.length} receipts as zip file`);
                }
            } catch (error) {
                console.error('Bulk download error:', error);
                showErrorMessage('Failed to download receipts');
            }
        }
    </script>
</body>
</html>

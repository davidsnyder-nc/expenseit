<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Details - Expense Wizard</title>
    <link rel="stylesheet" href="assets/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 id="tripTitle"><img src="assets/logo.png" alt="Expense Wizard" class="app-logo"> Trip Details</h1>
            <a href="index.html" class="back-link">
                <i data-feather="arrow-left"></i> Back to Dashboard
            </a>
        </header>

        <div class="trip-details" id="tripContent">
            <div class="loading" id="loadingState">
                <div class="spinner"></div>
                <p>Loading trip details...</p>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Receipt</h3>
                <button class="modal-close" onclick="closeModal()">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="modalContent"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/feather-icons"></script>
    <script>
        // Initialize feather icons
        feather.replace();

        let currentTrip = null;

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const tripName = urlParams.get('trip');
            
            if (tripName) {
                loadTripDetails(tripName);
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadTripDetails(tripName) {
            try {
                const response = await fetch(`api.php?action=trip&name=${encodeURIComponent(tripName)}`);
                const data = await response.json();
                
                if (data.success) {
                    currentTrip = data.trip;
                    displayTripDetails(data.trip);
                    loadTripReceipts(data.trip.name);
                } else {
                    showError('Failed to load trip details');
                }
            } catch (error) {
                console.error('Error loading trip:', error);
                showError('Error loading trip details');
            }
        }

        function displayTripDetails(trip) {
            const tripTitle = document.getElementById('tripTitle');
            const tripContent = document.getElementById('tripContent');
            
            tripTitle.innerHTML = `<i data-feather="map"></i> ${trip.metadata.name}`;
            
            const expenses = trip.expenses || [];
            const total = expenses.reduce((sum, expense) => sum + parseFloat(expense.amount || 0), 0);
            
            // Group expenses by category
            const categories = {};
            expenses.forEach(expense => {
                const category = expense.category || 'Uncategorized';
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push(expense);
            });

            tripContent.innerHTML = `
                <div class="trip-summary">
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div class="card-icon">
                                <i data-feather="calendar"></i>
                            </div>
                            <div class="card-content">
                                <h3>Duration</h3>
                                <p>${formatDate(trip.metadata.start_date)} - ${formatDate(trip.metadata.end_date)}</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="card-icon">
                                <i data-feather="file-text"></i>
                            </div>
                            <div class="card-content">
                                <h3>Expenses</h3>
                                <p>${expenses.length} items</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="card-icon">
                                <i data-feather="dollar-sign"></i>
                            </div>
                            <div class="card-content">
                                <h3>Total</h3>
                                <p class="amount">$${total.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>
                    
                    ${trip.metadata.notes ? `
                        <div class="trip-notes">
                            <h3><i data-feather="file-text"></i> Notes</h3>
                            <p>${trip.metadata.notes}</p>
                        </div>
                    ` : ''}
                    
                    <div class="trip-actions">
                        <button class="btn btn-primary" onclick="editTrip()">
                            <i data-feather="edit"></i> Edit Trip
                        </button>
                        <button class="btn btn-secondary" onclick="downloadReport()">
                            <i data-feather="download"></i> Download PDF
                        </button>
                        <button class="btn btn-outline" onclick="addExpense()">
                            <i data-feather="plus"></i> Add Expense
                        </button>
                        <button class="btn btn-danger" onclick="deleteTrip()">
                            <i data-feather="trash-2"></i> Delete Trip
                        </button>
                    </div>
                </div>

                <div class="receipts-section">
                    <h2><i data-feather="paperclip"></i> Receipts</h2>
                    <div class="receipts-grid" id="receiptsGrid">
                        <!-- Receipts will be loaded here -->
                    </div>
                </div>

                <div class="expenses-section">
                    <h2><i data-feather="list"></i> Expenses</h2>
                    
                    ${Object.keys(categories).length > 0 ? Object.keys(categories).map(category => `
                        <div class="category-section">
                            <h3 class="category-title">
                                <i data-feather="tag"></i> ${category}
                                <span class="category-total">$${categories[category].reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0).toFixed(2)}</span>
                            </h3>
                            <div class="expenses-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Merchant</th>
                                            <th>Amount</th>
                                            <th>Note</th>
                                            <th>Receipt</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${categories[category].map(expense => `
                                            <tr>
                                                <td>${formatDate(expense.date)}</td>
                                                <td>${expense.merchant || '-'}</td>
                                                <td class="amount">$${parseFloat(expense.amount || 0).toFixed(2)}</td>
                                                <td>${expense.note || '-'}</td>
                                                <td>
                                                    ${expense.source ? `
                                                        <button class="btn btn-small" onclick="viewReceipt('${expense.source}', '${expense.merchant || 'Receipt'}')">
                                                            <i data-feather="eye"></i> View
                                                        </button>
                                                    ` : '-'}
                                                </td>
                                                <td>
                                                    <button class="btn btn-small" onclick="editExpense('${expense.id}')">
                                                        <i data-feather="edit-2"></i>
                                                    </button>
                                                    <button class="btn btn-small btn-danger" onclick="deleteExpense('${expense.id}')">
                                                        <i data-feather="trash-2"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `).join('') : `
                        <div class="empty-state">
                            <i data-feather="inbox"></i>
                            <h3>No expenses found</h3>
                            <p>This trip doesn't have any expenses yet.</p>
                            <button class="btn btn-primary" onclick="addExpense()">
                                <i data-feather="plus"></i> Add First Expense
                            </button>
                        </div>
                    `}
                </div>
            `;
            
            // Re-initialize feather icons
            feather.replace();
        }

        function editTrip() {
            window.location.href = `edit.html?trip=${encodeURIComponent(currentTrip.name)}`;
        }

        function addExpense() {
            window.location.href = `edit.html?trip=${encodeURIComponent(currentTrip.name)}&action=add`;
        }

        function editExpense(expenseId) {
            window.location.href = `edit.html?trip=${encodeURIComponent(currentTrip.name)}&expense=${expenseId}`;
        }

        async function deleteExpense(expenseId) {
            if (!confirm('Are you sure you want to delete this expense?')) {
                return;
            }

            try {
                const response = await fetch('save_trip.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'delete_expense',
                        tripName: currentTrip.name,
                        expenseId: expenseId
                    })
                });

                const result = await response.json();
                if (result.success) {
                    // Reload trip details
                    loadTripDetails(currentTrip.name);
                } else {
                    alert('Error deleting expense');
                }
            } catch (error) {
                console.error('Error deleting expense:', error);
                alert('Error deleting expense');
            }
        }

        async function downloadReport() {
            try {
                const response = await fetch(`generate_pdf.php?trip=${encodeURIComponent(currentTrip.name)}`);
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${currentTrip.name}-report.pdf`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Error generating PDF report');
                }
            } catch (error) {
                console.error('Error downloading report:', error);
                alert('Error downloading report');
            }
        }

        async function deleteTrip() {
            const tripName = currentTrip.metadata.name;
            
            if (!confirm(`Are you sure you want to delete "${tripName}"?\n\nThis will permanently delete all trip data including expenses and receipts. This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch('save_trip.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'delete_trip',
                        tripName: currentTrip.name
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert('Trip deleted successfully');
                    window.location.href = 'index.html';
                } else {
                    alert('Error deleting trip: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting trip:', error);
                alert('Error deleting trip');
            }
        }

        function showError(message) {
            const tripContent = document.getElementById('tripContent');
            tripContent.innerHTML = `
                <div class="error-state">
                    <i data-feather="alert-circle"></i>
                    <h3>Error</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="window.location.href='index.html'">
                        <i data-feather="home"></i> Back to Dashboard
                    </button>
                </div>
            `;
            feather.replace();
        }

        async function loadTripReceipts(tripName) {
            try {
                const response = await fetch(`api.php?action=receipts&name=${encodeURIComponent(tripName)}`);
                const data = await response.json();
                
                if (data.success && data.receipts) {
                    displayReceipts(data.receipts);
                }
            } catch (error) {
                console.error('Error loading receipts:', error);
            }
        }

        function displayReceipts(receipts) {
            const receiptsGrid = document.getElementById('receiptsGrid');
            
            if (receipts.length === 0) {
                receiptsGrid.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="paperclip"></i>
                        <h3>No receipts found</h3>
                        <p>No receipt files are associated with this trip.</p>
                    </div>
                `;
            } else {
                receiptsGrid.innerHTML = receipts.map(receipt => `
                    <div class="receipt-item">
                        <div class="receipt-preview">
                            ${receipt.isPdf ? 
                                `<img src="${receipt.displayUrl}" alt="${receipt.filename}" class="receipt-thumbnail" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" loading="lazy">
                                 <div class="file-icon" style="display: none;"><i data-feather="file-text"></i></div>` :
                                `<img src="${receipt.displayUrl}" alt="${receipt.filename}" class="receipt-thumbnail" loading="lazy">`
                            }
                        </div>
                        <div class="receipt-info">
                            <div class="receipt-name">${receipt.filename}</div>
                            <div class="receipt-size">${formatFileSize(receipt.size)}</div>
                            ${receipt.isPdf ? '<div class="receipt-type">PDF Document</div>' : ''}
                        </div>
                        <div class="receipt-actions">
                            <button class="btn btn-small" onclick="viewReceipt('${receipt.filename}', '${receipt.fullUrl}', ${receipt.isPdf}, '${receipt.displayUrl}')">
                                <i data-feather="eye"></i> View
                            </button>
                            <a href="${receipt.fullUrl}" download class="btn btn-small btn-secondary">
                                <i data-feather="download"></i> Download
                            </a>
                        </div>
                    </div>
                `).join('');
            }
            
            feather.replace();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
        }

        // Modal functions
        function viewReceipt(filename, fullPath, isPdf = false, displayUrl = null) {
            const modal = document.getElementById('receiptModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            modalTitle.textContent = filename;
            
            if (isPdf) {
                // Use the provided displayUrl for PDFs (which should be the thumbnail URL)
                const thumbnailUrl = displayUrl || `thumbnail.php?file=${encodeURIComponent(filename)}&trip=${encodeURIComponent(currentTrip.name)}`;
                modalContent.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="${thumbnailUrl}" 
                             alt="${filename}" 
                             style="max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div style="display: none; padding: 40px; background: #f8f9fa; border-radius: 8px; border: 2px dashed #dee2e6;">
                            <div style="font-size: 48px; color: #6c757d; margin-bottom: 16px;">ðŸ“„</div>
                            <div style="font-size: 16px; color: #495057; font-weight: bold;">PDF Document</div>
                            <div style="font-size: 14px; color: #6c757d; margin-top: 8px;">Preview not available</div>
                        </div>
                    </div>
                    <div style="text-align: center; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <a href="${fullPath}" target="_blank" class="btn btn-secondary" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; text-decoration: none;">
                            <i data-feather="external-link"></i> Open PDF
                        </a>
                        <a href="${fullPath}" download class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; text-decoration: none;">
                            <i data-feather="download"></i> Download
                        </a>
                    </div>`;
            } else {
                modalContent.innerHTML = `
                    <div style="text-align: center;">
                        <img src="${displayUrl || fullPath}" 
                             alt="${filename}" 
                             style="max-width: 100%; max-height: 70vh; border-radius: 8px;" 
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjVmNWY1Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OTk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBmb3VuZDwvdGV4dD48L3N2Zz4='; this.onerror=null;">
                    </div>`;
            }
            
            modal.style.display = 'flex';
            feather.replace();
        }

        function closeModal() {
            const modal = document.getElementById('receiptModal');
            modal.style.display = 'none';
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('receiptModal');
            if (event.target === modal) {
                closeModal();
            }
        });

        // Close modal on escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>

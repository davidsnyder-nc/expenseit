<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trip Details - Expense Wizard</title>
    <link rel="stylesheet" href="assets/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-content">
                <div class="app-title">
                    <img src="assets/logo.png" alt="expense.it" class="app-logo">
                    <span class="app-name">expense<span class="brand-it">.it</span></span>
                </div>
                <a href="index.html" class="back-link">
                    <i data-feather="arrow-left"></i> Back to Dashboard
                </a>
            </div>
            <h1 id="tripTitle">Trip Details</h1>
        </header>

        <div class="trip-details" id="tripContent">
            <div class="loading" id="loadingState">
                <div class="spinner"></div>
                <p>Loading trip details...</p>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Receipt</h3>
                <button class="modal-close" onclick="closeModal()">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="modalContent"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // Initialize feather icons
        feather.replace();

        let currentTrip = null;
        let receiptsData = [];

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const tripName = urlParams.get('trip');
            
            if (tripName) {
                loadTripDetails(tripName);
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadTripDetails(tripName) {
            try {
                const response = await fetch(`api.php?action=trip&name=${encodeURIComponent(tripName)}`);
                const data = await response.json();
                
                if (data.success) {
                    currentTrip = data.trip;
                    displayTripDetails(data.trip);
                    loadAllFiles(data.trip.name);
                } else {
                    showError('Failed to load trip details');
                }
            } catch (error) {
                console.error('Error loading trip:', error);
                showError('Error loading trip details');
            }
        }

        function displayTripDetails(trip) {
            const tripTitle = document.getElementById('tripTitle');
            const tripContent = document.getElementById('tripContent');
            
            tripTitle.innerHTML = `<i data-feather="map"></i> ${trip.metadata.name}`;
            
            const allExpenses = trip.expenses || [];
            const expenses = allExpenses;
            const total = expenses.filter(expense => !expense.excluded).reduce((sum, expense) => sum + parseFloat(expense.amount || 0), 0);
            const taxTotal = expenses.filter(expense => !expense.excluded).reduce((sum, expense) => sum + parseFloat(expense.tax_amount || 0), 0);
            
            // Group expenses by category
            const categories = {};
            expenses.forEach(expense => {
                const category = expense.category || 'Uncategorized';
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push(expense);
            });

            tripContent.innerHTML = `
                <div class="trip-actions-card">
                    <div class="actions-grid">
                        <button class="action-card btn-primary" onclick="editTrip()">
                            <i data-feather="edit"></i>
                            <span>Edit Trip</span>
                        </button>
                        <button class="action-card btn-secondary" onclick="downloadReport()">
                            <i data-feather="download"></i>
                            <span>Download PDF</span>
                        </button>
                        <button class="action-card btn-secondary" onclick="exportToPlainText()">
                            <i data-feather="clipboard"></i>
                            <span>Copy as Text</span>
                        </button>
                        <button class="action-card btn-outline" onclick="addExpense()">
                            <i data-feather="plus"></i>
                            <span>Add Expense</span>
                        </button>
                        <button class="action-card btn-danger" onclick="deleteTrip()">
                            <i data-feather="trash-2"></i>
                            <span>Delete Trip</span>
                        </button>
                    </div>
                </div>

                <div class="trip-summary">
                    <div class="trip-stats">
                        <div class="stat-item">
                            <div class="stat-icon duration">
                                <i data-feather="calendar"></i>
                            </div>
                            <div class="stat-content">
                                <h3>Duration</h3>
                                <p>${trip.metadata.start_date && trip.metadata.end_date ? 
                                    `${formatDate(trip.metadata.start_date)} - ${formatDate(trip.metadata.end_date)}` : 
                                    'Not specified'}</p>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon expenses">
                                <i data-feather="file-text"></i>
                            </div>
                            <div class="stat-content">
                                <h3>Expenses</h3>
                                <p>${expenses.length} items</p>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon total">
                                <i data-feather="dollar-sign"></i>
                            </div>
                            <div class="stat-content">
                                <h3>Total</h3>
                                <p>$${total.toFixed(2)}</p>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon tax">
                                <i data-feather="percent"></i>
                            </div>
                            <div class="stat-content">
                                <h3>Tax Total</h3>
                                <p>$${taxTotal.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>
                    
                    ${trip.metadata.notes ? `
                        <div class="trip-notes">
                            <h3><i data-feather="file-text"></i> Notes</h3>
                            <p>${trip.metadata.notes}</p>
                        </div>
                    ` : ''}
                </div>

                <div class="receipts-section">
                    <div class="section-header">
                        <h2><i data-feather="paperclip"></i> Files</h2>
                        <button class="btn btn-secondary" onclick="bulkDownloadReceipts()" id="bulkDownloadBtn" style="display: none;">
                            <i data-feather="download"></i> Download All Files
                        </button>
                    </div>
                    <div class="receipts-grid" id="receiptsGrid">
                        <!-- All files will be loaded here -->
                    </div>
                </div>

                <div class="expenses-section">
                    <h2><i data-feather="list"></i> Expenses</h2>
                    
                    ${Object.keys(categories).length > 0 ? Object.keys(categories).map(category => `
                        <div class="category-section">
                            <h3 class="category-title">
                                <i data-feather="tag"></i> ${category}
                                <span class="category-total">$${categories[category].filter(exp => !exp.excluded).reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0).toFixed(2)}</span>
                            </h3>
                            <div class="expenses-table-container">
                                <table class="expenses-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Merchant</th>
                                            <th>Amount</th>
                                            <th>Tax</th>
                                            <th>Note</th>
                                            <th>Receipt</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${categories[category].map(expense => `
                                            <tr class="${expense.excluded ? 'excluded-expense' : ''}">
                                                <td>${formatDate(expense.date)}</td>
                                                <td>${expense.merchant || '-'}</td>
                                                <td class="amount">$${parseFloat(expense.amount || 0).toFixed(2)}</td>
                                                <td class="amount">${expense.tax_amount ? '$' + parseFloat(expense.tax_amount).toFixed(2) : '-'}</td>
                                                <td>${formatExpenseNote(expense.note)}</td>
                                                <td>
                                                    ${expense.source ? `
                                                        <a href="data/trips/${currentTrip.name}/${expense.source.replace(/\\s+/g, '_').replace(/\\u202f/g, '').replace('4.05.38', '40538').replace('4.05.57', '40557').replace('_AM', 'AM')}" target="_blank" class="btn btn-small">
                                                            <i data-feather="eye"></i> View
                                                        </a>
                                                    ` : '-'}
                                                </td>
                                                <td>
                                                    <button class="btn btn-small" onclick="editExpense('${expense.id}')" title="Edit">
                                                        <i data-feather="edit-2"></i>
                                                    </button>
                                                    <button class="btn btn-small ${expense.excluded ? 'btn-success' : 'btn-warning'}" onclick="toggleExpenseExclusion('${expense.id}')" title="${expense.excluded ? 'Include' : 'Exclude'}">
                                                        <i data-feather="${expense.excluded ? 'eye' : 'eye-off'}"></i>
                                                    </button>
                                                    <button class="btn btn-small btn-danger" onclick="deleteExpense('${expense.id}')" title="Delete">
                                                        <i data-feather="trash-2"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            ${expense.is_hotel_stay && expense.daily_breakdown && expense.daily_breakdown.length > 0 ? `
                                                <tr class="hotel-breakdown-row">
                                                    <td colspan="7">
                                                        <div class="hotel-breakdown">
                                                            <h4><i data-feather="calendar"></i> Daily Breakdown</h4>
                                                            <div class="daily-breakdown-table">
                                                                <table>
                                                                    <thead>
                                                                        <tr>
                                                                            <th>Date</th>
                                                                            <th>Room Rate</th>
                                                                            <th>Tax Rate</th>
                                                                            <th>Tax %</th>
                                                                            <th>Daily Total</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        ${expense.daily_breakdown.map(day => `
                                                                            <tr>
                                                                                <td>${formatDate(day.date)}</td>
                                                                                <td class="amount">$${parseFloat(day.room_rate || 0).toFixed(2)}</td>
                                                                                <td class="amount">$${parseFloat(day.tax_rate || 0).toFixed(2)}</td>
                                                                                <td>${day.tax_percentage || '-'}</td>
                                                                                <td class="amount">$${parseFloat(day.daily_total || 0).toFixed(2)}</td>
                                                                            </tr>
                                                                        `).join('')}
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ` : ''}
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `).join('') : `
                        <div class="empty-state">
                            <i data-feather="inbox"></i>
                            <h3>No expenses found</h3>
                            <p>This trip doesn't have any expenses yet.</p>
                            <button class="btn btn-primary" onclick="addExpense()">
                                <i data-feather="plus"></i> Add First Expense
                            </button>
                        </div>
                    `}
                </div>
            `;
            
            // Re-initialize feather icons
            feather.replace();
        }

        async function loadAllFiles(tripName) {
            try {
                // Load receipts
                const receiptsResponse = await fetch(`api.php?action=receipts&name=${encodeURIComponent(tripName)}`);
                const receiptsData = await receiptsResponse.json();
                
                // Load travel documents
                const docsResponse = await fetch(`api.php?action=travel_documents&name=${encodeURIComponent(tripName)}`);
                const docsData = await docsResponse.json();
                
                const allFiles = [];
                
                // Add receipts with type
                if (receiptsData.success && receiptsData.receipts) {
                    receiptsData.receipts.forEach(file => {
                        allFiles.push({...file, type: 'receipt'});
                    });
                }
                
                // Add travel documents with type
                if (docsData.success && docsData.documents) {
                    docsData.documents.forEach(file => {
                        allFiles.push({...file, type: 'travel_document'});
                    });
                }
                
                console.log('Loaded files:', allFiles); // Debug log
                displayAllFiles(allFiles);
                
            } catch (error) {
                console.error('Error loading files:', error);
            }
        }

        function displayAllFiles(files) {
            const grid = document.getElementById('receiptsGrid');
            const bulkBtn = document.getElementById('bulkDownloadBtn');
            
            if (!files || files.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="inbox"></i>
                        <h3>No files uploaded</h3>
                        <p>Upload receipts and travel documents to see them here.</p>
                    </div>
                `;
                feather.replace();
                return;
            }
            
            // Show bulk download button if there are files
            bulkBtn.style.display = 'inline-flex';
            
            grid.innerHTML = files.map(file => {
                // Use the correct path structure from API response
                const filePath = file.fullUrl || file.displayUrl || file.path;
                const isPdf = file.isPdf || file.filename.toLowerCase().endsWith('.pdf');
                
                return `
                    <div class="receipt-item">
                        <div class="receipt-preview">
                            ${isPdf ? 
                                `<div class="pdf-icon"><i data-feather="file-text"></i></div>` :
                                `<img src="${filePath}" alt="${file.filename}" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                 <div class="pdf-icon" style="display: none;"><i data-feather="image"></i></div>`
                            }
                        </div>
                        <div class="receipt-info">
                            <h4>${file.filename}</h4>
                            <p class="file-type">${file.type === 'travel_document' ? 'Travel Document' : 'Receipt'}</p>
                            <p class="file-size">${formatFileSize(file.size || 0)}</p>
                            <div class="receipt-actions">
                                <a href="${filePath}" target="_blank" class="btn btn-small">
                                    <i data-feather="eye"></i> View
                                </a>
                                <a href="${filePath}" download="${file.filename}" class="btn btn-small btn-secondary">
                                    <i data-feather="download"></i> Download
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            feather.replace();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function showError(message) {
            const tripContent = document.getElementById('tripContent');
            tripContent.innerHTML = `
                <div class="error-state">
                    <i data-feather="alert-circle"></i>
                    <h3>Error</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="window.location.reload()">
                        <i data-feather="refresh-cw"></i> Retry
                    </button>
                </div>
            `;
            feather.replace();
        }

        function closeModal() {
            const modal = document.getElementById('receiptModal');
            modal.style.display = 'none';
        }

        function editTrip() {
            // Create trip edit modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Edit Trip Details</h3>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="editTripForm">
                            <div class="form-group">
                                <label for="editTripName">Trip Name:</label>
                                <input type="text" id="editTripName" value="${currentTrip.metadata.name}" required>
                            </div>
                            <div class="form-group">
                                <label for="editDestination">Destination:</label>
                                <input type="text" id="editDestination" value="${currentTrip.metadata.destination || ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="editStartDate">Start Date:</label>
                                <input type="date" id="editStartDate" value="${currentTrip.metadata.start_date}" required>
                            </div>
                            <div class="form-group">
                                <label for="editEndDate">End Date:</label>
                                <input type="date" id="editEndDate" value="${currentTrip.metadata.end_date}" required>
                            </div>
                            <div class="form-group">
                                <label for="editNotes">Notes:</label>
                                <textarea id="editNotes" rows="3">${currentTrip.metadata.notes || ''}</textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveTrip()">Save Changes</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function saveTrip() {
            const form = document.getElementById('editTripForm');
            const formData = new FormData();
            
            formData.append('action', 'update_trip');
            formData.append('original_name', currentTrip.name);
            formData.append('name', document.getElementById('editTripName').value);
            formData.append('destination', document.getElementById('editDestination').value);
            formData.append('start_date', document.getElementById('editStartDate').value);
            formData.append('end_date', document.getElementById('editEndDate').value);
            formData.append('notes', document.getElementById('editNotes').value);

            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccessMessage('Trip updated successfully');
                    // Close modal
                    document.querySelector('.modal').remove();
                    // Reload trip details
                    loadTripDetails(currentTrip.name);
                } else {
                    showErrorMessage('Failed to update trip: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating trip:', error);
                showErrorMessage('Error updating trip');
            }
        }

        function editExpense(expenseId) {
            const expense = currentTrip.expenses.find(e => e.id === expenseId);
            if (!expense) return;

            // Create edit modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Edit Expense</h3>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="editExpenseForm">
                            <div class="form-group">
                                <label for="editDate">Date:</label>
                                <input type="date" id="editDate" value="${expense.date}" required>
                            </div>
                            <div class="form-group">
                                <label for="editMerchant">Merchant:</label>
                                <input type="text" id="editMerchant" value="${expense.merchant || ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="editAmount">Amount:</label>
                                <input type="number" id="editAmount" step="0.01" value="${expense.amount}" required>
                            </div>
                            <div class="form-group">
                                <label for="editTaxAmount">Tax Amount:</label>
                                <input type="number" id="editTaxAmount" step="0.01" value="${expense.tax_amount || ''}" placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label for="editCategory">Category:</label>
                                <select id="editCategory">
                                    <option value="Food & Dining" ${expense.category === 'Food & Dining' ? 'selected' : ''}>Food & Dining</option>
                                    <option value="Transportation" ${expense.category === 'Transportation' ? 'selected' : ''}>Transportation</option>
                                    <option value="Accommodation" ${expense.category === 'Accommodation' ? 'selected' : ''}>Accommodation</option>
                                    <option value="Entertainment" ${expense.category === 'Entertainment' ? 'selected' : ''}>Entertainment</option>
                                    <option value="Shopping" ${expense.category === 'Shopping' ? 'selected' : ''}>Shopping</option>
                                    <option value="Travel Documents" ${expense.category === 'Travel Documents' ? 'selected' : ''}>Travel Documents</option>
                                    <option value="Other" ${expense.category === 'Other' ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editNote">Notes:</label>
                                <textarea id="editNote" rows="3">${expense.note || ''}</textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveExpense('${expenseId}')">Save Changes</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function saveExpense(expenseId) {
            const formData = new FormData();
            
            formData.append('action', 'update_expense');
            formData.append('trip_name', currentTrip.name);
            formData.append('expense_id', expenseId);
            formData.append('date', document.getElementById('editDate').value);
            formData.append('merchant', document.getElementById('editMerchant').value);
            formData.append('amount', document.getElementById('editAmount').value);
            formData.append('tax_amount', document.getElementById('editTaxAmount').value || '0');
            formData.append('category', document.getElementById('editCategory').value);
            formData.append('note', document.getElementById('editNote').value);

            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccessMessage('Expense updated successfully');
                    // Close modal
                    document.querySelector('.modal').remove();
                    // Reload trip details
                    loadTripDetails(currentTrip.name);
                } else {
                    showErrorMessage('Failed to update expense: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating expense:', error);
                showErrorMessage('Error updating expense');
            }
        }

        function downloadReport() {
            if (!currentTrip) return;
            
            window.open(`generate_pdf.php?trip=${encodeURIComponent(currentTrip.name)}`, '_blank');
        }

        function exportToPlainText() {
            if (!currentTrip) return;
            
            // Generate plain text report
            let plainText = `TRIP EXPENSE REPORT\n`;
            plainText += `${'='.repeat(50)}\n\n`;
            plainText += `Trip: ${currentTrip.metadata.name}\n`;
            plainText += `Destination: ${currentTrip.metadata.destination || 'Not specified'}\n`;
            plainText += `Duration: ${formatDate(currentTrip.metadata.start_date)} - ${formatDate(currentTrip.metadata.end_date)}\n`;
            if (currentTrip.metadata.notes) {
                plainText += `Notes: ${currentTrip.metadata.notes}\n`;
            }
            plainText += `\n`;

            const expenses = currentTrip.expenses || [];
            const total = expenses.filter(expense => !expense.excluded).reduce((sum, expense) => sum + parseFloat(expense.amount || 0), 0);
            const taxTotal = expenses.filter(expense => !expense.excluded).reduce((sum, expense) => sum + parseFloat(expense.tax_amount || 0), 0);

            plainText += `SUMMARY\n`;
            plainText += `${'='.repeat(20)}\n`;
            plainText += `Total Expenses: ${expenses.length}\n`;
            plainText += `Total Amount: $${total.toFixed(2)}\n`;
            plainText += `Total Tax: $${taxTotal.toFixed(2)}\n`;
            plainText += `Grand Total: $${(total + taxTotal).toFixed(2)}\n\n`;

            // Group by category
            const categories = {};
            expenses.forEach(expense => {
                const category = expense.category || 'Uncategorized';
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push(expense);
            });

            plainText += `DETAILED EXPENSES\n`;
            plainText += `${'='.repeat(30)}\n\n`;

            Object.keys(categories).forEach(category => {
                const categoryExpenses = categories[category];
                const categoryTotal = categoryExpenses.filter(exp => !exp.excluded).reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
                
                plainText += `${category.toUpperCase()} - $${categoryTotal.toFixed(2)}\n`;
                plainText += `${'-'.repeat(category.length + 15)}\n`;
                
                categoryExpenses.forEach(expense => {
                    plainText += `${formatDate(expense.date)}\t${expense.merchant || 'Unknown'}\t$${parseFloat(expense.amount || 0).toFixed(2)}`;
                    if (expense.tax_amount) {
                        plainText += `\tTax: $${parseFloat(expense.tax_amount).toFixed(2)}`;
                    }
                    if (expense.note && expense.note !== '-') {
                        plainText += `\t(${expense.note})`;
                    }
                    if (expense.excluded) {
                        plainText += `\t[EXCLUDED]`;
                    }
                    plainText += `\n`;
                });
                plainText += `\n`;
            });
            
            // Simple: just open text in new tab
            const blob = new Blob([plainText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
            showSuccessMessage('Trip report opened in new tab');
        }

        function deleteTrip() {
            showConfirmModal(
                'Delete Trip',
                'Are you sure you want to permanently delete this trip and all its data? This action cannot be undone.',
                () => {
                    showSuccessMessage('Delete trip functionality will be implemented');
                }
            );
        }

        function formatExpenseNote(note) {
            if (!note || note === '-') return '-';
            
            // Check if note is long enough to truncate
            if (note.length <= 100) {
                return escapeHtml(note);
            }
            
            // Split by newlines and common delimiters for structured notes
            const items = note.split(/[\n\r]+/)
                .filter(item => item.trim().length > 0)
                .map(item => item.trim());
            
            let preview;
            if (items.length > 3) {
                // Show first 3 items for structured lists
                preview = items.slice(0, 3).join(', ') + '...';
            } else {
                // For long unstructured text, show first 100 characters
                preview = note.substring(0, 100) + '...';
            }
            
            // Use proper HTML escaping for both preview and tooltip
            const escapedNote = escapeHtml(note).replace(/"/g, '&quot;');
            const escapedPreview = escapeHtml(preview);
            
            return `<span title="${escapedNote}" style="cursor: help;">${escapedPreview}</span>`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showSuccessMessage(message) {
            showToast(message, 'success');
        }

        function showErrorMessage(message) {
            showToast(message, 'error');
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-content">
                    <i data-feather="${type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'info'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            feather.replace();
            
            // Show toast
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Hide and remove toast
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function addExpense() {
            showSuccessMessage('Add expense functionality will be implemented');
        }

        function toggleExpenseExclusion(expenseId) {
            showSuccessMessage('Toggle expense functionality will be implemented');
        }

        function deleteExpense(expenseId) {
            showSuccessMessage('Delete expense functionality will be implemented');
        }

        function bulkDownloadReceipts() {
            showSuccessMessage('Bulk download functionality will be implemented');
        }

        function showConfirmModal(title, message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${title}</h3>
                    </div>
                    <div class="modal-body">
                        <p>${message}</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-danger" onclick="this.closest('.modal').remove(); (${onConfirm.toString()})()">Confirm</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
    </script>
</body>
</html>